#include <dem_test_check.H>

#include <AMReX_ParmParse.H>

#include <cmath>

using namespace amrex;

dem_test_check::dem_test_check ()
  : m_epsilon(1.e-6)
{
  m_vel.resize(62);
  m_vel = {
           {3.899602,0.0,0.0},
           {3.899826,0.030834,0.0},
           {3.899433,0.059271,0.012598},
           {3.89941,0.082102,0.036554},
           {3.897489,0.096129,0.069841},
           {3.896392,0.098855,0.10979},
           {3.884664,0.136389,0.236232},
           {3.866892,0.113198,0.348387},
           {3.841376,0.04572,0.434996},
           {3.807108,-0.053536,0.509358},
           {3.767693,-0.183886,0.565941},
           {3.719944,-0.343231,0.594494},
           {3.66412,-0.526584,0.584831},
           {3.60306,-0.726793,0.528046},
           {3.53392,-0.934167,0.415918},
           {3.45973,-1.140105,0.242337},
           {3.377731,-1.328519,0.0},
           {3.289212,-1.457686,-0.309841},
           {3.194186,-1.506593,-0.670779},
           {3.093931,-1.460173,-1.060878},
           {2.988171,-1.309558,-1.454411},
           {2.875678,-1.052852,-1.823593},
           {2.758168,-0.695367,-2.14012},
           {2.634967,-0.249882,-2.377467},
           {2.507308,0.264067,-2.51243},
           {2.374606,0.821117,-2.527138},
           {2.236698,1.391558,-2.41025},
           {2.095517,1.942925,-2.157837},
           {1.950308,2.442156,-1.77433},
           {1.80046,2.857592,-1.272282},
           {1.647889,3.160746,-0.671838},
           {3.899602,0.0,0.0},
           {3.899826,0.030748,0.003231},
           {3.899433,0.057798,0.01878},
           {3.89941,0.078089,0.045084},
           {3.897489,0.088597,0.079773},
           {3.896392,0.087144,0.119943},
           {3.884664,0.111432,0.25028},
           {3.866892,0.07652,0.359996},
           {3.841376,0.0,0.439457},
           {3.807108,-0.106963,0.503222},
           {3.767693,-0.243014,0.545817},
           {3.719944,-0.404792,0.557148},
           {3.66412,-0.586364,0.527964},
           {3.60306,-0.779354,0.449961},
           {3.53392,-0.973479,0.316302},
           {3.45973,-1.159444,0.121863},
           {3.377731,-1.321241,-0.138868},
           {3.289212,-1.417314,-0.460513},
           {3.194186,-1.428224,-0.824586},
           {3.093931,-1.341282,-1.207696},
           {2.988171,-1.150356,-1.58333},
           {2.875678,-0.856467,-1.923656},
           {2.758168,-0.467854,-2.201082},
           {2.634967,0.0,-2.390563},
           {2.507308,0.52524,-2.471064},
           {2.374606,1.080777,-2.427464},
           {2.236698,1.635875,-2.251589},
           {2.095517,2.157837,-1.942925},
           {1.950308,2.614246,-1.509336},
           {1.80046,2.974928,-0.966613},
           {1.647889,3.213657,-0.337769}
  };

  m_omega.resize(62);

  m_omega = {
             {0.0,0.0,0.0},
             {0.0,0.0,3.164268},
             {0.0,-1.537096,7.231663},
             {0.0,-4.922264,11.055535},
             {0.0,-10.070865,13.861444},
             {0.0,-16.495665,14.852766},
             {0.0,-57.777364,33.357886},
             {0.0,-134.992654,43.861871},
             {0.0,-237.201061,24.930979},
             {0.0,-328.332981,-34.509205},
             {0.0,-391.954551,-127.35376},
             {0.0,-418.977348,-241.896452},
             {0.0,-404.434194,-364.154178},
             {0.0,-347.566441,-478.384298},
             {0.0,-253.33842,-569.007369},
             {0.0,-131.513397,-618.722495},
             {0.0,0.0,-618.907859},
             {0.0,125.324223,-589.604513},
             {0.0,238.1343,-534.858313},
             {0.0,333.355339,-458.824328},
             {0.0,407.061081,-366.519483},
             {0.0,456.596643,-263.616249},
             {0.0,480.99277,-156.283991},
             {0.0,480.605736,-50.513661},
             {0.0,457.367421,48.071185},
             {0.0,414.29522,134.612724},
             {0.0,355.457416,205.223392},
             {0.0,285.79897,257.334497},
             {0.0,210.40981,289.604264},
             {0.0,134.461603,302.005721},
             {0.0,62.920041,296.015426},
             {0.0,0.0,0.0},
             {0.0,-0.323885,3.081961},
             {0.0,-2.241626,6.899024},
             {0.0,-5.931997,10.274574},
             {0.0,-11.250981,12.49549},
             {0.0,-17.610369,12.794664},
             {0.0,-60.055072,26.738268},
             {0.0,-137.547319,29.236623},
             {0.0,-237.112731,0.0},
             {0.0,-321.568283,-68.351307},
             {0.0,-375.309772,-167.098743},
             {0.0,-390.622362,-283.803824},
             {0.0,-363.676865,-403.904084},
             {0.0,-295.577295,-511.954707},
             {0.0,-192.593024,-592.740693},
             {0.0,-66.233445,-630.168988},
             {0.0,64.828123,-616.796985},
             {0.0,186.645086,-574.434852},
             {0.0,293.313037,-508.033136},
             {0.0,380.211724,-422.267813},
             {0.0,443.957505,-322.55393},
             {0.0,482.502733,-214.823989},
             {0.0,495.533029,-105.328696},
             {0.0,484.035882,0.0},
             {0.0,450.530517,95.763142},
             {0.0,398.535672,177.439522},
             {0.0,332.515024,241.586244},
             {0.0,257.665799,286.166917},
             {0.0,179.199758,310.383001},
             {0.0,102.269861,314.754135},
             {0.0,31.665296,301.27541}
  };
}

bool dem_test_check::compare (MFIXParticleContainer& pc, int nlev) const {
  using MFIXParIter = MFIXParticleContainer::MFIXParIter;
  for (int lev = 0; lev < nlev; ++lev) {
    for (MFIXParIter pti(pc, lev); pti.isValid(); ++pti) {
      auto& soa = pti.GetStructOfArrays();
      auto p_realarray = soa.realarray();

      for (int i = 0; i < 62; ++i) {
        Real velx = p_realarray[SoArealData::velx][i];
        Real vely = p_realarray[SoArealData::vely][i];
        Real velz = p_realarray[SoArealData::velz][i];
        if ( (std::abs(velx - m_vel[i][0]) > m_epsilon) ||
             (std::abs(vely - m_vel[i][1]) > m_epsilon) ||
             (std::abs(velz - m_vel[i][2]) > m_epsilon) )
        {
          return false;
        }
      }

      for (int i = 0; i < 62; ++i) {
        Real omegax = p_realarray[SoArealData::omegax][i];
        Real omegay = p_realarray[SoArealData::omegay][i];
        Real omegaz = p_realarray[SoArealData::omegaz][i];
        if ( (std::abs(omegax - m_omega[i][0]) > m_epsilon) ||
             (std::abs(omegay - m_omega[i][1]) > m_epsilon) ||
             (std::abs(omegaz - m_omega[i][2]) > m_epsilon) )
        {
          return false;
        }
      }
    }
  }
  return true;
}

bool dem_test_check::rolling_friction_inputs (MFIXDEM& dem) const
{
  // Rolling friction inputs check
  if (dem.rolling_friction() != RollingFrictionModel::None) {
    return false;
  }

  // Model A
  {
    ParmParse pp;
    pp.add("dem.rolling_friction", std::string("moDELa"));
    pp.add("dem.rolling_friction.coefficient", 0.2);
    dem.Initialize();
    if (dem.rolling_friction() != RollingFrictionModel::ModelA) { return false; }
    if (dem.rolling_friction_coeff() != 0.2) { return false; }
    pp.remove("dem.rolling_friction");
    pp.remove("dem.rolling_friction.coefficient");
  }

  // Model B
  {
    ParmParse pp;
    pp.add("dem.rolling_friction", std::string("mODelB"));
    pp.add("dem.rolling_friction.coefficient", 0.2);
    dem.Initialize();
    if (dem.rolling_friction() != RollingFrictionModel::ModelB) { return false; }
    if (dem.rolling_friction_coeff() != 0.2) { return false; }
    pp.remove("dem.rolling_friction");
    pp.remove("dem.rolling_friction.coefficient");
  }

  return true;
}
